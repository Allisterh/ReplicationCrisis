## Overview
This repository contains code that create a dataset of global stock returns and characteristics. The dataset was created for the paper [Is There a Replication Crisis in Finance?](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3774514) by Jensen, Kelly and Pedersen (2021). Please cite this paper if you are using the code or data.

Documentation.pdf provides detailed descriptions of the code and all data construction choices. chars.xlsx lists the 153 factors (and their original sources, directional bets, and significance in the original paper) studied in Jensen, Kelly and Pedersen (2021), which is a subset of the factors/characteristics generated by this code.

## How to Generate Dataset
The .sas files construct the stock-level characteristics and factor portfolio returns for all countries. The code requires a connection to WRDS servers. Below we outline our preferred approach to creating the dataset:

1. Connect to the [SAS studio server hosted by WRDS](https://wrds-cloud.wharton.upenn.edu/SASStudio/index?locale=en_US).  
2. Create a folder called _Global Data_ in your home directory and upload `main.sas`, `project_macros.sas`, `market_chars.sas`, `accounting_chars.sas`, `char_macros.sas`, `portfolios.sas`, `ind_identification.sas` and `chars.xlsx` to this folder.
3. Create an empty folder in your institutions scratch folder. The scratch folder is located at "Sever Files and Folders/Files/scratch/\<institution name\>".
4. Open `main.sas`. 
5. Replace line 8 with the path to the scratch folder created in step 3. 
6. Run `main.sas`.  

For step 6, we suggest that you make a background submit. To do so, locate the `main.sas` file in your _Global Data_ folder, right-clik the file and select "Background Submit". Running the code will take around 24 hours. When the code has finished running, your scratch folder will contain a folder called _output_. This folder contains daily and monthly market returns, market equity breakpoints from NYSE and return breakpoints from CRSP. Furthermore, the scratch folder will contain the main dataset called _world_data.sas7bdat_. If you wish to have the data in .csv format, run the  `%save_main_data_csv()` macro on line 220. The macro will create a zip folder with a separate .csv file for each country and save it in the output folder. Importantly, the datasets only include the main observation of common stocks that are primary securities, with non-missing market equity data. 

Note that the space in the scratch directory is shared across users in your institution. It's best practice to delete files after downloading what you need. Furthermore, files in the scratch directory is deleted after 7 days.

## How to Generate Portfolio Returns
The file `portfolio.R` generates country level factor returns based on the dataset generated by `main.sas`:

1. Run `main.sas`.
2. Save country level .csv files by running the macro `save_main_data_csv()` in `main.sas`.
3. Download the folder named _output_ to a local directory and unzip.
4. Open `portfolio.R`.
5. User defined inputs:
    i.  Replace the variable `data_path` with the path to the folder where you have unzipped the              content of _output_.
    ii. Replace the variable `output_path` with the path to the folder where you wish to save the             factor returns. 
    iii. Replace the variable `legacy_path` with the path to the folder where you wish to save earlier          versions of the factor output. If you don't wish to save earlier version, set the variabl to         `NULL`.
    iv. The variable `countries` controls which countries to generate factor returns for. By default,         it selects all the countries in `data_path`.
    v. The variable `chars` controls which characteristics to use for creating factor returns. By             default, it is set to the 153 characteristics from Jensen, Kelly and Pedersen (2021). Any             column in the charactersitic dataset can be used to as the basis of a factor. 
    vi. The variable `settings` controls the end date, number of portfolio, which breakpoints to use,         the data source, whether to winsorize Compustat returns, the minimum amount of stocks for             breakpoints to be valid and whether to create rank weighted (characteristic managed)                  portfolios in each of the 5 size groups. Default settings are the same as used in Jensen,             Kelly and Pedersen (2021).
  6. Run `portfolio.R`.
  
  The code will generate 5 files, _hml.csv_ contains the high minus low portfolios. Note that the portfolios has not been signed to produce a positive return. For example the high minus low asset growth portfolio (_at_gr1_) goes long stocks with a high asset growth and short stocks with low asset growth even though stocks with low asset growth have historically outperformed. Table J.1 in Jensen, Kelly and Pedersen (2021) shows how we signed the factor for the paper. _pfs.csv_ includes the individual portfolios that are the basis of the high minus low portfolios. _cmp.csv_ includes the characteristic managed portfolios. _market_returns.csv_ includes monthly market returns. _settings.RDS_ copies the `settings` variable for easy reference.
